<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Feed</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    nav { background: #333; color: #fff; display: flex; padding: 10px; }
    nav button { background: none; border: none; color: white; margin-right: 10px; cursor: pointer; }
    .tab { display: none; padding: 20px; }
    .active { display: block; }
    video { max-width: 100%; margin-top: 10px; }
    #feed video { border: 2px solid #ccc; margin-top: 10px; }
  </style>
</head>
<body>

<nav>
  <button onclick="openTab('upload')">Upload</button>
  <button onclick="openTab('feed')">Feed</button>
  <button onclick="openTab('connect')">Conectar</button>
</nav>

<div id="upload" class="tab active">
  <h2>Upload de Vídeo</h2>
  <input type="file" id="videoUpload" accept="video/*">
  <video id="localVideo" controls></video>
  <br>
  <button onclick="adicionarAoFeed()">Adicionar ao Feed</button>
</div>

<div id="feed" class="tab">
  <h2>Feed de Vídeos</h2>
  <div id="videoFeed"></div>
</div>

<div id="connect" class="tab">
  <h2>Conexão WebRTC</h2>
  <button onclick="generateId()">Gerar ID</button>
  <p>Seu ID: <span id="myId"></span></p>
  <input type="text" id="remoteId" placeholder="ID remoto">
  <button onclick="connectToPeer()">Conectar</button>
  <div id="status"></div>
</div>

<script>
  // Troca de abas
  function openTab(tabId) {
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
  }

  // Upload e exibição local
  let videoFileBlob = null;
  document.getElementById('videoUpload').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      videoFileBlob = URL.createObjectURL(file);
      document.getElementById('localVideo').src = videoFileBlob;
    }
  });

  function adicionarAoFeed() {
    if (!videoFileBlob) return alert("Selecione um vídeo primeiro.");
    const video = document.createElement('video');
    video.src = videoFileBlob;
    video.controls = true;
    document.getElementById('videoFeed').appendChild(video);
    sendVideoToPeer(videoFileBlob); // Envia via WebRTC se conectado
  }

  // --- WebRTC Simplificado ---
  let localConnection, remoteConnection;
  let sendChannel, receiveChannel;
  let peerId = Math.random().toString(36).substring(2, 8);
  document.getElementById('myId').textContent = peerId;

  const connections = {}; // Fake sinalização entre abas

  function generateId() {
    alert("Seu ID: " + peerId);
  }

  function connectToPeer() {
    const targetId = document.getElementById('remoteId').value;
    if (!targetId) return alert("Digite um ID remoto.");

    // Criando a conexão
    localConnection = new RTCPeerConnection();
    sendChannel = localConnection.createDataChannel("video");

    sendChannel.onopen = () => {
      document.getElementById('status').textContent = "Conectado a " + targetId;
    };

    sendChannel.onclose = () => {
      document.getElementById('status').textContent = "Canal fechado.";
    };

    localConnection.createOffer().then(offer => {
      return localConnection.setLocalDescription(offer);
    }).then(() => {
      connections[targetId] = {
        offer: localConnection.localDescription,
        onAnswer: function(answer) {
          localConnection.setRemoteDescription(answer);
        }
      };
      listenForAnswer(targetId);
    });

    // Fake signal
    window.setTimeout(() => {
      const other = connections[peerId];
      if (other) {
        remoteConnection = new RTCPeerConnection();
        remoteConnection.ondatachannel = event => {
          receiveChannel = event.channel;
          receiveChannel.onmessage = (e) => receiveVideo(e.data);
        };

        remoteConnection.setRemoteDescription(other.offer).then(() => {
          return remoteConnection.createAnswer();
        }).then(answer => {
          return remoteConnection.setLocalDescription(answer);
        }).then(() => {
          other.onAnswer(remoteConnection.localDescription);
        });
      }
    }, 500);
  }

  function listenForAnswer(targetId) {
    // Simulação de escuta de resposta do par
    console.log("Aguardando resposta de " + targetId);
  }

  function sendVideoToPeer(blobUrl) {
    if (sendChannel && sendChannel.readyState === "open") {
      fetch(blobUrl)
        .then(res => res.blob())
        .then(blob => {
          const reader = new FileReader();
          reader.onload = function () {
            sendChannel.send(reader.result);
          };
          reader.readAsDataURL(blob);
        });
    }
  }

  function receiveVideo(dataUrl) {
    const video = document.createElement('video');
    video.src = dataUrl;
    video.controls = true;
    document.getElementById('videoFeed').appendChild(video);
  }
</script>

</body>
</html>
