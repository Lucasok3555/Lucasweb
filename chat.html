<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web de Mensagem P2P com PeerJS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      background-color: #f4f4f4;
    }

    #sidebar {
      width: 300px;
      background-color: white;
      border-right: 1px solid #ddd;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .user-item:hover {
      background-color: #e9ecef;
    }

    .user-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .user-item span {
      font-size: 16px;
      color: #333;
    }

    /* Modal */
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      text-align: center;
    }

    .modal input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Usuários Conectados</h2>
    <ul id="user-list"></ul>
  </div>

  <!-- Modal para Adicionar Usuário -->
  <div id="overlay"></div>
  <div id="add-user-modal" class="modal">
    <h3>Adicionar Novo Usuário</h3>
    <input type="text" id="new-user-id-input" placeholder="Digite o ID do usuário" />
    <button id="add-user">Adicionar</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    const peer = new Peer();
    let localPeerId = null;
    const users = {}; // Armazena os usuários conectados

    // Quando o ID do PeerJS estiver disponível
    peer.on('open', (id) => {
      localPeerId = id;
      console.log(`Seu ID: ${localPeerId}`);
    });

    // Quando receber uma conexão de outro peer
    peer.on('connection', (conn) => {
      const userId = conn.peer;
      if (!users[userId]) {
        addUserToList(userId);
      }
    });

    function addUserToList(userId) {
      users[userId] = true;

      const userList = document.getElementById('user-list');
      const userItem = document.createElement('li');
      userItem.className = 'user-item';

      const userAvatar = document.createElement('img');
      userAvatar.src = `https://avatars.dicebear.com/api/initials/${userId}.svg`; // Avatar dinâmico

      const userName = document.createElement('span');
      userName.textContent = `Usuário ${userId}`;

      userItem.appendChild(userAvatar);
      userItem.appendChild(userName);

      userItem.addEventListener('click', () => openChatWindow(userId));
      userList.appendChild(userItem);
    }

    function openChatWindow(userId) {
      const chatWindow = window.open('', `_chat_${userId}`, 'width=400,height=600');
      chatWindow.document.write(`
        <!DOCTYPE html>
        <html lang="pt-br">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Chat com Usuário ${userId}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
              display: flex;
              flex-direction: column;
              height: 100vh;
              background-color: #f4f4f4;
            }
            #chat-container {
              flex-grow: 1;
              display: flex;
              flex-direction: column;
              padding: 20px;
              box-sizing: border-box;
            }
            #chat-messages {
              flex-grow: 1;
              padding: 10px;
              overflow-y: auto;
              border-bottom: 1px solid #ddd;
            }
            .message {
              margin-bottom: 10px;
              padding: 10px;
              border-radius: 5px;
              max-width: 70%;
            }
            .message.sent {
              background-color: #dcf8c6;
              align-self: flex-end;
            }
            .message.received {
              background-color: #e9ecef;
              align-self: flex-start;
            }
            #chat-input {
              display: flex;
              padding: 10px;
              border-top: 1px solid #ddd;
            }
            #chat-input input[type="text"] {
              flex-grow: 1;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 4px;
              margin-right: 10px;
            }
            #chat-input button {
              padding: 10px 20px;
              background-color: #007bff;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            }
            #chat-input button:hover {
              background-color: #0056b3;
            }
          </style>
        </head>
        <body>
          <div id="chat-container">
            <div id="chat-header">Chat com Usuário ${userId}</div>
            <div id="chat-messages"></div>
            <div id="chat-input">
              <input type="text" id="message-input" placeholder="Digite sua mensagem..." />
              <button id="send-message">Enviar</button>
            </div>
          </div>
          <script>
            const peer = new Peer();
            let currentConnection = null;

            // Conectar ao usuário selecionado
            const conn = peer.connect('${userId}');
            setupConnection(conn);

            function setupConnection(conn) {
              currentConnection = conn;

              conn.on('data', (message) => {
                displayMessage('${userId}', message, 'received');
              });

              conn.on('open', () => {
                console.log('Conexão aberta com ${userId}');
              });

              conn.on('close', () => {
                console.log('Conexão fechada com ${userId}');
                currentConnection = null;
              });
            }

            document.getElementById('send-message').addEventListener('click', () => {
              const messageInput = document.getElementById('message-input');
              const message = messageInput.value.trim();

              if (message && currentConnection && currentConnection.open) {
                currentConnection.send(message);
                displayMessage('${localPeerId}', message, 'sent');
                messageInput.value = '';
              } else {
                alert('Você precisa estar conectado para enviar mensagens.');
              }
            });

            function displayMessage(peerId, message, type) {
              const chatMessages = document.getElementById('chat-messages');
              const messageDiv = document.createElement('div');
              messageDiv.className = \`message \${type}\`;

              const senderIdSpan = document.createElement('span');
              senderIdSpan.textContent = type === 'sent' ? \`Você\` : \`Remetente: \${peerId}\`;
              senderIdSpan.style.fontSize = '12px';
              senderIdSpan.style.color = '#666';
              senderIdSpan.style.display = 'block';

              const messageText = document.createElement('span');
              messageText.textContent = message;

              messageDiv.appendChild(senderIdSpan);
              messageDiv.appendChild(messageText);

              chatMessages.appendChild(messageDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          </script>
        </body>
        </html>
      `);
      chatWindow.document.close();
    }

    document.getElementById('add-user').addEventListener('click', () => {
      const userId = document.getElementById('new-user-id-input').value.trim();
      if (userId && userId !== localPeerId) {
        if (!users[userId]) {
          addUserToList(userId);
          closeModal();
        } else {
          alert('Este usuário já está na lista.');
        }
      } else {
        alert('Por favor, insira um ID válido.');
      }
    });

    function closeModal() {
      document.getElementById('overlay').style.display = 'none';
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
      document.getElementById('new-user-id-input').value = '';
    }
  </script>
</body>
</html>
